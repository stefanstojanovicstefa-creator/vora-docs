{
  "project": "Vora Voice Platform",
  "branchName": "ralph/audit-02-phase-1-tutorial-trigger",
  "description": "Phase 1: Fix tutorial trigger bug. Three compounding bugs prevent the tutorial from ever showing: missing auth guard on query, zero validation event dispatchers, dead code. IMPORTANT: Code is at ventus-voice/frontend/src/ (NOT root frontend/).",
  "userStories": [
    {
      "id": "US-001",
      "title": "Add auth guard to tutorial state query",
      "description": "As a user, I want the tutorial to appear after I sign in for the first time, not fail silently due to unauthenticated API calls.",
      "acceptanceCriteria": [
        "IMPORTANT: Code is at ventus-voice/frontend/src/ (NOT root frontend/)",
        "In useTutorial.ts (around line 92-97), add enabled option to the useQuery call",
        "Import useAuth from @clerk/clerk-react at the top of useTutorial.ts",
        "Call const { isSignedIn } = useAuth() inside the useTutorial hook",
        "Set enabled: !!isSignedIn on the useQuery options object so the query only fires when authenticated",
        "The query should NOT fire on public routes (landing page, sign-in page)",
        "When authenticated, the query should fetch /api/tutorial/state and shouldShowTutorial should become true for new users",
        "Files: ventus-voice/frontend/src/hooks/useTutorial.ts",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Added useAuth import from @clerk/clerk-react, destructured isSignedIn, added enabled: !!isSignedIn to useQuery options. Query now only fires when user is authenticated."
    },
    {
      "id": "US-002",
      "title": "Add tutorial validation events to agent creation flows",
      "description": "As a user completing the tutorial, I want step 2 (Create Agent) to be validated when I successfully create an agent.",
      "acceptanceCriteria": [
        "IMPORTANT: Code is at ventus-voice/frontend/src/ (NOT root frontend/)",
        "In InterviewBot.tsx, find the handleOverlayComplete function (around line 867-874). After the toast.success and before navigate(), add: window.dispatchEvent(new CustomEvent('tutorial:validation', { detail: { key: 'agent_created' } }))",
        "In EnhancedAgentWizard.tsx, find handleDeploy function (around line 144-147). After toast.success and before navigate(), add the same dispatch",
        "The CustomEvent detail must have key: 'agent_created' exactly (this matches what TutorialSystem.tsx listens for)",
        "Do NOT modify TutorialSystem.tsx -- the listener is already correct",
        "Files: ventus-voice/frontend/src/pages/InterviewBot.tsx, ventus-voice/frontend/src/components/AgentWizard/EnhancedAgentWizard.tsx",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Added window.dispatchEvent(new CustomEvent('tutorial:validation', { detail: { key: 'agent_created' } })) in InterviewBot.tsx handleOverlayComplete and EnhancedAgentWizard.tsx handleDeploy, both after toast.success and before navigate."
    },
    {
      "id": "US-003",
      "title": "Add tutorial validation events to agent test flows",
      "description": "As a user completing the tutorial, I want step 3 (Test Agent) to be validated when I complete a test call.",
      "acceptanceCriteria": [
        "IMPORTANT: Code is at ventus-voice/frontend/src/ (NOT root frontend/)",
        "In AgentTestPage.tsx, find handleEndCall (around line 126-136). After endVoiceSession() resolves, add: if (transcript.length > 0) { window.dispatchEvent(new CustomEvent('tutorial:validation', { detail: { key: 'agent_tested' } })) }",
        "In TestPanel.tsx, find handleEndCall (around line 253-266). After endCall() resolves, add the same dispatch with the transcript length check",
        "Only dispatch if transcript.length > 0 (so just opening and immediately closing doesnt count)",
        "The CustomEvent detail must have key: 'agent_tested' exactly",
        "Files: ventus-voice/frontend/src/pages/AgentTestPage.tsx, ventus-voice/frontend/src/components/AgentTesting/TestPanel.tsx",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Added tutorial:validation dispatch with key 'agent_tested' in AgentTestPage.tsx and TestPanel.tsx handleEndCall, gated by transcript.length > 0."
    },
    {
      "id": "US-004",
      "title": "Add tutorial validation events to phone connection flows",
      "description": "As a user completing the tutorial, I want step 4 (Connect Number) to be validated when I connect a phone number.",
      "acceptanceCriteria": [
        "IMPORTANT: Code is at ventus-voice/frontend/src/ (NOT root frontend/)",
        "In PhoneNumbersPage.tsx, find createTrunkMutation onSuccess callback (around line 161-165). After toast.success, add: window.dispatchEvent(new CustomEvent('tutorial:validation', { detail: { key: 'phone_connected' } }))",
        "In SIPSetupWizard.tsx, find createTrunkMutation onSuccess callback (around line 107-113). After toast.success, add the same dispatch",
        "The CustomEvent detail must have key: 'phone_connected' exactly",
        "Files: ventus-voice/frontend/src/pages/PhoneNumbersPage.tsx, ventus-voice/frontend/src/components/SIPWizard/SIPSetupWizard.tsx",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Delete dead useTutorialProgress hook",
      "description": "As a developer, I want dead code removed so it doesnt confuse future contributors.",
      "acceptanceCriteria": [
        "IMPORTANT: Code is at ventus-voice/frontend/src/ (NOT root frontend/)",
        "Delete the file ventus-voice/frontend/src/hooks/useTutorialProgress.ts",
        "Verify no imports reference useTutorialProgress anywhere (grep the entire frontend/src directory)",
        "If any imports exist, remove them",
        "Files: ventus-voice/frontend/src/hooks/useTutorialProgress.ts (DELETE)",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    }
  ]
}
