{
  "project": "Vora Voice Platform",
  "branchName": "ralph/phase-4-feature-completion",
  "description": "Phase 4: Feature Completion - Flow Studio validate/test handlers, auto-language detection, brand analyzer quality, model list update, model routing layer, platform policies, and embed snippet UI. IMPORTANT: The codebase is at ventus-voice/frontend/ and ventus-voice/backend/ (NOT at project root frontend/ backend/).",
  "userStories": [
    {
      "id": "US-401",
      "title": "Flow Studio Validate Handler",
      "description": "As a user, I want the Flow Studio Validate button to perform graph validation and report errors so I can fix broken flows before publishing.",
      "acceptanceCriteria": [
        "IMPORTANT: Code is at ventus-voice/frontend/src/ and ventus-voice/backend/src/ (NOT root frontend/ or backend/)",
        "Find FlowStudioPage.tsx in ventus-voice/frontend/src/ and locate the Validate button (around lines 274-277) which has no onClick handler",
        "Implement a validateFlow function that checks: (1) orphan nodes (no incoming or outgoing edges, excluding start node), (2) missing end conditions (no terminal/end node), (3) circular dependencies (cycle detection), (4) required field checks (empty required fields per node type)",
        "Wire the Validate button onClick to call validateFlow",
        "Display validation results: green checkmark + 'Flow is valid' on success, red error list with node names and specific issues on failure",
        "Use toast notifications or an inline panel to show results",
        "If a Publish handler exists, run validation as a pre-check before publish",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Implemented validateFlow with 5 checks: (1) orphan nodes (no edges, excluding start/note), (2) missing endCall terminal node, (3) DFS-based cycle detection, (4) required field checks for message/question/capture/apiCall/transfer/function/goTo nodes, (5) start node connectivity. Validate button wired to handleValidate which shows sonner toast: green success or red error list (up to 5 shown, overflow counted). Publish button wired to handlePublish which runs validation as pre-check and blocks publish if errors found. Added AlertTriangle icon import. TypeScript typecheck passes (zero errors)."
    },
    {
      "id": "US-402",
      "title": "Flow Studio Test Handler",
      "description": "As a user, I want the Flow Studio Test button to simulate a flow run with test input and display step-by-step results so I can verify flow behavior.",
      "acceptanceCriteria": [
        "IMPORTANT: Code is at ventus-voice/frontend/src/ and ventus-voice/backend/src/ (NOT root frontend/ or backend/)",
        "Find FlowStudioPage.tsx in ventus-voice/frontend/src/ and locate the Test button (around lines 274-281) which has no onClick handler",
        "Test button opens a test panel or modal with an input field for test data (e.g. sample user message)",
        "Clicking 'Run Test' simulates flow execution with provided input",
        "Step-by-step execution displayed: visited nodes highlighted, decision branch choices shown, variable values at each step",
        "Final output/response displayed in results panel",
        "Errors during execution caught and displayed (e.g. node handler fails, infinite loop detected with 30s timeout)",
        "Validation (US-401) runs as pre-check before test execution; test blocked if validation fails",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-403",
      "title": "Auto-Language Detection in URL Wizard",
      "description": "As a user creating an agent from a URL, I want the wizard to auto-detect the website language and pre-configure my agent's language settings.",
      "acceptanceCriteria": [
        "IMPORTANT: Code is at ventus-voice/frontend/src/ and ventus-voice/backend/src/ (NOT root frontend/ or backend/)",
        "Find brand-analyzer.service.ts in ventus-voice/backend/src/services/ai/",
        "Add language detection to the brand analysis pipeline (use LLM-based identification during brand analysis or character set detection)",
        "Include detectedLanguage field (e.g. 'ja', 'en', 'fr', 'ar') in the brand analysis response payload",
        "Find the URL creation wizard component in ventus-voice/frontend/src/ and consume the detectedLanguage field",
        "Pre-configure STT language, TTS language/voice, and agent response language from detected language",
        "User can override auto-detected language in the wizard UI",
        "English websites still default correctly (no regression)",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-404",
      "title": "Brand Analyzer Prompt Quality Improvement",
      "description": "As a user, I want the AI brand analysis to produce richer, more specific agent configurations including audience, competitors, jargon, and use-case scenarios.",
      "acceptanceCriteria": [
        "IMPORTANT: Code is at ventus-voice/frontend/src/ and ventus-voice/backend/src/ (NOT root frontend/ or backend/)",
        "Find the brand analysis prompt in ventus-voice/backend/src/services/ai/ (openrouter.service.ts or brand-analyzer.service.ts)",
        "Enrich the prompt to extract: (1) target audience (demographics, pain points), (2) competitor analysis (competitors and differentiators), (3) vocabulary/jargon (domain-specific terms, acronyms), (4) use-case scenarios (top 3-5 conversations the agent should handle)",
        "Add new structured fields in the analysis output for each extraction category",
        "Generated system prompts incorporate extracted audience, jargon, and scenarios",
        "Agent personality is more specific and domain-aware compared to current generic output",
        "No regression in analysis speed",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-405",
      "title": "Update Compiler Model List",
      "description": "As a user, I want the model selector to offer current-generation models (Gemini 2.5, Claude 4, latest Llama) instead of only MiniMax M2.",
      "acceptanceCriteria": [
        "IMPORTANT: Code is at ventus-voice/frontend/src/ and ventus-voice/backend/src/ (NOT root frontend/ or backend/)",
        "Find model configuration in ventus-voice/backend/src/services/ai/ (openrouter.service.ts or similar)",
        "Add models: Gemini 2.5 Pro, Gemini 2.5 Flash, Claude 4 Sonnet, Claude 4 Haiku, latest Llama (via OpenRouter), retain MiniMax M2 as free tier",
        "Each model entry has: name, provider, pricing tier, capability tags",
        "MiniMax M2 is clearly labeled as free tier option",
        "Model selection persists correctly when saving agent configuration",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-406",
      "title": "Implement Model Routing Layer",
      "description": "As a platform operator, I want a model routing layer that selects appropriate models based on task complexity to reduce LLM costs by ~40% for summarization tasks.",
      "acceptanceCriteria": [
        "IMPORTANT: Code is at ventus-voice/frontend/src/ and ventus-voice/backend/src/ (NOT root frontend/ or backend/)",
        "Create model-router.service.ts in ventus-voice/backend/src/services/ai/ with task category definitions: brand-analysis (complex), summarization (simple), embedding, extraction",
        "Model mapping: brand-analysis -> Gemini 2.5 Flash or premium model, summarization -> free model via OpenRouter, embedding -> current model, extraction -> mid-tier model",
        "Implement getModel(taskType: string, orgId?: string) method",
        "Add per-organization override capability (premium orgs can force premium models)",
        "Refactor existing LLM callers to use modelRouter.getModel(taskType) instead of hardcoded model names",
        "Implement fallback: if routed model fails, retry with default model",
        "Add logging: each routed call logs task type, selected model, and cost estimate",
        "No regression in output quality for brand analysis",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-407",
      "title": "Platform Policies Pages",
      "description": "As a user, I want to access Privacy Policy, Terms of Service, Cookie Policy, DPA, and AUP from the platform so Vora meets legal requirements for launch.",
      "acceptanceCriteria": [
        "IMPORTANT: Code is at ventus-voice/frontend/src/ and ventus-voice/backend/src/ (NOT root frontend/ or backend/)",
        "Create policy page components in ventus-voice/frontend/src/pages/ for: Privacy Policy, Terms of Service, Cookie Policy, DPA, Acceptable Use Policy",
        "Create /policies route with sub-routes: /policies/privacy, /policies/terms, /policies/cookies, /policies/dpa, /policies/aup",
        "Each policy page has: clean readable layout, table of contents for navigation, last-updated date, correct rendering in both light and dark themes",
        "Policy content covers voice data processing, transcripts, memory storage, third-party sharing, service levels, cookie types, GDPR Article 28, prohibited uses",
        "Add footer links to policy pages in landing page and in-app layout",
        "Note: These are AI-generated templates requiring legal review before production",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-408",
      "title": "Deploy UI for Embed Snippets",
      "description": "As a user, I want a deployment page where I can select an agent, choose an embed format (script tag, iframe, React component), customize options, and copy the snippet.",
      "acceptanceCriteria": [
        "IMPORTANT: Code is at ventus-voice/frontend/src/ and ventus-voice/backend/src/ (NOT root frontend/ or backend/)",
        "Create a deploy/embed page in ventus-voice/frontend/src/pages/ accessible from agent management or sidebar",
        "User can select which agent to deploy from a dropdown or list",
        "Three embed format tabs: Script tag (simplest), Iframe (sandboxed), React component (for React/Next.js apps) with descriptions",
        "Code snippets update dynamically based on selected agent ID and customization options (theme, position, size)",
        "Copy button for each snippet with 'Copied!' feedback",
        "Preview panel showing what the embedded widget looks like",
        "Code snippets are syntax-highlighted for readability",
        "Page renders correctly in both light and dark themes",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    }
  ]
}
